# 결제/구독 웹훅 정리

## 웹훅이란?
- 결제 상태 변경, 결제 취소, 빌링키 해지 같은 이벤트를 토스가 서버로 자동 전송하는 알림입니다.
- 사용자가 직접 호출하지 않아도 상태가 바뀔 수 있는 상황을 자동으로 동기화합니다.

## 전송 로그가 꼭 필요한가?
- 필수는 아닙니다.
- 현재 결제/구독/해지 플로우가 정상이라면 운영은 가능합니다.
- 다만 다음 상황에서는 웹훅이 있어야 자동 반영됩니다.

## 웹훅이 중요한 상황
- 결제 실패가 발생했는데 사용자가 다시 페이지를 열지 않는 경우
- 결제 취소(관리자/사용자)로 상태가 바뀌는 경우
- 빌링키가 강제 해지되는 경우
- 자동결제 스케줄러가 결제 결과를 놓쳤을 때

## 현재 프로젝트 흐름 요약
- 사용자가 결제를 진행하면 서버에서 결제 승인 결과를 직접 저장합니다.
- 구독 해지 예약은 내부 RPC로 처리됩니다.
- 웹훅은 보조 신호로서 결제/구독 상태를 최신으로 유지하는 역할입니다.

## 웹훅이 없어도 가능한 범위
- 결제 성공/해지 예약이 사용자의 직접 동작에서만 발생하는 경우
- 결제 실패가 별도 자동 처리되지 않아도 되는 초기 MVP 단계

## 웹훅이 있으면 좋은 점
- 결제 실패/취소가 실시간 반영
- 자동결제 상태와 UI가 항상 일치
- 결제 이슈 대응 시간 단축

---

# 다음 기능 개발 제안

## 1. 웹훅 운영 안정화
- 전송 기록 확인 및 재전송 기능 점검
- 이벤트 중복 처리(이미 적용됨)
- 웹훅 실패시 경고 알림(슬랙/메일) 추가

## 2. 구독 상태 자동 정리
- cancel_at 만료 시 subscriptions.status_code 자동 전환
- billing_profiles.status_code 동기화

## 3. 결제 실패 재시도 정책
- 재시도 횟수/간격 정책 도입
- 실패 기록/알림 UX 추가

## 4. 요금제 변경(업/다운 그레이드)
- 즉시 반영 vs 다음 주기 반영 정책
- 프레이트/차액 처리

## 5. 결제수단 변경
- 빌링키 재발급 및 구독 연결
- 기존 빌링키 폐기 정책

## 6. 운영 대시보드
- 구독 상태, 결제 성공/실패, 최근 이벤트 모니터링
- 수동 재처리 버튼

## 7. 알림 시스템
- 결제 실패, 해지 예약, 만료 임박 알림
- 이메일/슬랙/푸시 선택
